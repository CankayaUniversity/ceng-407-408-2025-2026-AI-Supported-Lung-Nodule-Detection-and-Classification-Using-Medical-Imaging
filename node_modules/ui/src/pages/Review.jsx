import { useState, useEffect, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { mockStudies } from '../data/mockStudies';
import './Review.css';
import { studyAPI } from '../services/api';
import { cornerstone, displayDicomImage, enableImageTools, resetViewport } from '../utils/dicomUtils';

export default function Review(){
  const { studyId } = useParams();
  const navigate = useNavigate();
  const viewerRef = useRef(null);
  const [study, setStudy] = useState(null);
  const [dicomFiles, setDicomFiles] = useState([]);
  const [currentImageIndex, setCurrentImageIndex] = useState(0);
  const [loading, setLoading] = useState(true);
  const [showSegmentation, setShowSegmentation] = useState(false);
  const [showHeatmap, setShowHeatmap] = useState(false);

  useEffect(() => {
    loadStudyData();
  }, [studyId]);

  useEffect(() => {
    if (dicomFiles.length > 0 && viewerRef.current) {
      loadDicomImage(currentImageIndex);
    }
  }, [currentImageIndex, dicomFiles]);

  const loadStudyData = async () => {
    try {
      setLoading(true);
      
      // Try to load from database
      const response = await studyAPI.getById(studyId);
      const studyData = response.data;
      
      setStudy(studyData);
      
      if (studyData.dicomFiles && studyData.dicomFiles.length > 0) {
        setDicomFiles(studyData.dicomFiles);
      }
      
      setLoading(false);
    } catch (error) {
      console.error('Error loading study:', error);
      // Fallback to mock data
      const mockStudy = mockStudies.find(s => s.id === studyId) || mockStudies[0];
      setStudy(mockStudy);
      setLoading(false);
    }
  };

  const loadDicomImage = async (index) => {
    if (!viewerRef.current || !dicomFiles[index]) return;

    try {
      const file = dicomFiles[index];
      const imageId = `wadouri:http://localhost:3001${file.file_path}`;
      
      await displayDicomImage(viewerRef.current, imageId);
      enableImageTools(viewerRef.current);
    } catch (error) {
      console.error('Error loading DICOM image:', error);
    }
  };

  const handlePreviousImage = () => {
    if (currentImageIndex > 0) {
      setCurrentImageIndex(currentImageIndex - 1);
    }
  };

  const handleNextImage = () => {
    if (currentImageIndex < dicomFiles.length - 1) {
      setCurrentImageIndex(currentImageIndex + 1);
    }
  };

  const handleResetView = () => {
    if (viewerRef.current) {
      resetViewport(viewerRef.current);
    }
  };

  if (loading) {
    return (
      <div className="review-page">
        <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
          <p>Loading study...</p>
        </div>
      </div>
    );
  }

  if (!study) {
    return (
      <div className="review-page">
        <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
          <p>Study not found</p>
        </div>
      </div>
    );
  }

  return (
    <div className="review-page">
      <div className="review-header">
        <button className="back-button" onClick={() => navigate(-1)}>← Back to Worklist</button>
        <div className="review-title">
          <h2>{study.patient_name || study.patientName}</h2>
          <p>{study.patient_id || study.patientID} | {study.study_date || study.studyDate}</p>
        </div>
      </div>

      <div className="review-container">
        <div className="review-left-panel">
          <div className="panel-header"><h3>Patient & AI Summary</h3></div>
          <div style={{padding:16}}>
            <div className="info-grid">
              <div className="info-item">
                <span className="info-label">Patient ID</span>
                <span className="info-value">{study.patient_id || study.patientID}</span>
              </div>
              <div className="info-item">
                <span className="info-label">Age</span>
                <span className="info-value">{study.age || '62'}</span>
              </div>
              <div className="info-item">
                <span className="info-label">Gender</span>
                <span className="info-value">{study.gender || 'M'}</span>
              </div>
            </div>
            <div className="ai-summary-box">
              <div className="summary-item">
                <span className="summary-label">Total nodules</span>
                <span className="summary-value">{study.nodule_count || study.noduleCount || 0}</span>
              </div>
              <div className="summary-item">
                <span className="summary-label">High risk</span>
                <span className="summary-value">{Math.max(0, Math.floor((study.nodule_count || study.noduleCount || 0)/3))}</span>
              </div>
              <div className="summary-item">
                <span className="summary-label">Largest</span>
                <span className="summary-value">{(study.nodule_count || study.noduleCount) > 0 ? '12.4 mm': 'N/A'}</span>
              </div>
              <div className="summary-item">
                <span className="summary-label">Images</span>
                <span className="summary-value">{dicomFiles.length}</span>
              </div>
            </div>
          </div>
        </div>

        <div className="review-center-panel">
          <div className="viewer-container">
            {dicomFiles.length > 0 ? (
              <>
                <div 
                  ref={viewerRef}
                  className="dicom-viewer"
                  style={{
                    width: '100%',
                    height: '500px',
                    backgroundColor: '#000',
                    position: 'relative'
                  }}
                />
                <div className="viewer-controls" style={{marginTop: 16, display: 'flex', gap: 8, justifyContent: 'center', flexWrap: 'wrap'}}>
                  <button className="open-btn" onClick={handlePreviousImage} disabled={currentImageIndex === 0}>
                    ← Previous
                  </button>
                  <span style={{padding: '8px 16px', background: '#1b2430', borderRadius: 4}}>
                    {currentImageIndex + 1} / {dicomFiles.length}
                  </span>
                  <button className="open-btn" onClick={handleNextImage} disabled={currentImageIndex === dicomFiles.length - 1}>
                    Next →
                  </button>
                  <button className="open-btn" onClick={handleResetView}>
                    Reset View
                  </button>
                  <button 
                    className="open-btn" 
                    onClick={() => setShowSegmentation(!showSegmentation)}
                    style={{background: showSegmentation ? '#3b82f6' : undefined}}
                  >
                    {showSegmentation ? '✓' : ''} Segmentation
                  </button>
                  <button 
                    className="open-btn"
                    onClick={() => setShowHeatmap(!showHeatmap)}
                    style={{background: showHeatmap ? '#3b82f6' : undefined}}
                  >
                    {showHeatmap ? '✓' : ''} Heatmap
                  </button>
                </div>
                <div style={{marginTop: 8, textAlign: 'center', color: '#64748b', fontSize: '12px'}}>
                  <p>Mouse: Left-drag to adjust window/level • Scroll to zoom</p>
                </div>
              </>
            ) : (
              <div className="viewer-placeholder">
                <div className="placeholder-content">
                  <h4>No DICOM Images</h4>
                  <p>Study: {study.study_id || study.id}</p>
                  <p style={{color: '#64748b', marginTop: 12}}>
                    No DICOM files found for this study.
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="review-right-panel">
          <div className="panel-header"><h3>Nodules</h3></div>
          <div className="nodules-list">
            {Array.from({length: study.nodule_count || study.noduleCount || 0}).map((_,i)=> (
              <div key={i} className="nodule-card">
                <div className="nodule-header">
                  <div>
                    <strong className="nodule-title">Nodule #{i+1}</strong>
                    <div className="nodule-location">RUL • {6+i*2} mm</div>
                  </div>
                  <span className="risk-badge high">High</span>
                </div>
              </div>
            ))}
          </div>

          <div className="selected-nodule-section">
            <h4>Selected Nodule Details</h4>
            <div className="detail-form">
              <div className="form-group">
                <label className="form-label">Location</label>
                <select className="form-control">
                  <option>RUL</option>
                  <option>LUL</option>
                  <option>RML</option>
                  <option>RLL</option>
                  <option>LLL</option>
                </select>
              </div>
              
              <div className="form-group">
                <label className="form-label">Size (mm)</label>
                <input type="number" defaultValue="12.4" className="form-control" />
              </div>
              
              <div className="form-group">
                <label className="form-label">AI Probability</label>
                <input type="number" defaultValue="0.78" step="0.01" className="form-control" />
              </div>
              
              <div className="form-group checkbox-group">
                <label className="checkbox-label">
                  <input type="checkbox" defaultChecked /> Include in report
                </label>
              </div>
              
              <div className="form-group">
                <label className="form-label">Notes</label>
                <textarea placeholder="Add clinical notes..." className="form-control textarea-control" />
              </div>

              <div className="form-actions">
                <button className="open-btn">Previous Nodule</button>
                <button className="open-btn">Next Nodule</button>
              </div>
              
              <button className="submit-report-btn">Generate Report</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

